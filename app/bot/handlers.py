from aiogram import Router, types
from aiogram.filters import Command
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton
from app.ai.core import KnowledgeBase

# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
router = Router()
# –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É –∑–Ω–∞–Ω–∏–π (–æ–Ω–∞ –±—É–¥–µ—Ç –æ–¥–Ω–∞ –Ω–∞ –≤—Å–µ—Ö)
kb = KnowledgeBase()

# –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ –º–µ–Ω—é
def get_main_keyboard():
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üìö –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ò–ò")],
            [KeyboardButton(text="‚öñÔ∏è –¢—Ä—É–¥–æ–≤–æ–π –∫–æ–¥–µ–∫—Å"), KeyboardButton(text="üìä –°–û–£–¢ 426-–§–ó")],
            [KeyboardButton(text="üéì –û–±—É—á–µ–Ω–∏–µ –ø–æ –û–¢"), KeyboardButton(text="üè¢ –°–£–û–¢")],
            [KeyboardButton(text="üìÑ –®–∞–±–ª–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"), KeyboardButton(text="‚ùì –ü–æ–º–æ—â—å")]
        ],
        resize_keyboard=True
    )
    return keyboard

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@router.message(Command("start"))
async def cmd_start(message: Message):
    welcome_text = (
        "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –±–æ—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞.\n\n"
        "–Ø –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ:\n"
        "‚Ä¢ –¢—Ä—É–¥–æ–≤–æ–≥–æ –∫–æ–¥–µ–∫—Å–∞ –†–§\n"
        "‚Ä¢ –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–≤\n"
        "‚Ä¢ –ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ç–æ–≤\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º!"
    )
    await message.answer(welcome_text, reply_markup=get_main_keyboard())

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
@router.message(Command("help"))
async def cmd_help(message: Message):
    help_text = (
        "üÜò **–ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞:**\n\n"
        "‚Ä¢ **–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ò–ò** ‚Äî –∑–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞, –∏ —è –Ω–∞–π–¥—É –æ—Ç–≤–µ—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö\n"
        "‚Ä¢ **–¢—Ä—É–¥–æ–≤–æ–π –∫–æ–¥–µ–∫—Å** ‚Äî –≤–æ–ø—Ä–æ—Å—ã –ø–æ –¢–ö –†–§\n"
        "‚Ä¢ **–°–û–£–¢ 426-–§–ó** ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞\n"
        "‚Ä¢ **–û–±—É—á–µ–Ω–∏–µ –ø–æ –û–¢** ‚Äî –æ–±—É—á–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π\n"
        "‚Ä¢ **–°–£–û–¢** ‚Äî —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞\n"
        "‚Ä¢ **–®–∞–±–ª–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** ‚Äî –æ–±—Ä–∞–∑—Ü—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å!"
    )
    await message.answer(help_text, reply_markup=get_main_keyboard())

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ò–ò"
@router.message(lambda message: message.text == "üìö –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ò–ò")
async def ask_ai_mode(message: Message):
    await message.answer(
        "üí° **–†–µ–∂–∏–º –ò–ò-–ø–æ–∏—Å–∫–∞ –≤–∫–ª—é—á–µ–Ω.**\n\n"
        "–ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞, –∏ —è –Ω–∞–π–¥—É –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ "
        "—Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏–∑ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.\n\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
        "‚Ä¢ _–ö–∞–∫–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ —É —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è?_\n"
        "‚Ä¢ _–ö–∞–∫ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞?_\n"
        "‚Ä¢ _–ö–∞–∫–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –µ–∂–µ–≥–æ–¥–Ω–æ–≥–æ –æ—Ç–ø—É—Å–∫–∞?_"
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ–∏—Å–∫)
@router.message()
async def handle_text_message(message: Message):
    user_text = message.text.strip()
    
    if not user_text:
        return
    
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
    button_texts = ["‚öñÔ∏è –¢—Ä—É–¥–æ–≤–æ–π –∫–æ–¥–µ–∫—Å", "üìä –°–û–£–¢ 426-–§–ó", "üéì –û–±—É—á–µ–Ω–∏–µ –ø–æ –û–¢", 
                    "üè¢ –°–£–û–¢", "üìÑ –®–∞–±–ª–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤", "‚ùì –ü–æ–º–æ—â—å"]
    if user_text in button_texts:
        # –í—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
        await message.answer(f"–†–∞–∑–¥–µ–ª '{user_text}' –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ü–æ–∫–∞ –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ!")
        return
    
    # –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –Ω–∞—á–∞–ª–µ –ø–æ–∏—Å–∫–∞
    search_msg = await message.answer("üîç –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö...")
    
    try:
        # –ò—â–µ–º –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        results = kb.search(user_text, k=3)
        
        if not results:
            await search_msg.edit_text(
                "‚ùå –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö.\n\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –∏–∑ –º–µ–Ω—é."
            )
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        response_text = f"üìÑ **–ù–∞–π–¥–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É:**\n\n"
        
        for i, (doc, score) in enumerate(results, 1):
            # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            content = doc.page_content
            if len(content) > 400:
                content = content[:400] + "..."
            
            response_text += (
                f"**{i}. [{doc.metadata.get('source', '–î–æ–∫—É–º–µ–Ω—Ç')}]**\n"
                f"_(—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {score:.2f})_\n"
                f"{content}\n\n"
            )
        
        response_text += (
            "\n---\n"
            "üí° _–û—Ç–≤–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. "
            "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º._"
        )
        
        await search_msg.edit_text(response_text)
        
    except Exception as e:
        await search_msg.edit_text(
            f"‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:\n\n`{str(e)}`\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        )
