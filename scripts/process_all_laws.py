#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –í–°–ï–• –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞.
–°–æ–∑–¥–∞–µ—Ç –µ–¥–∏–Ω—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –∏–∑ –≤—Å–µ—Ö –∑–∞–∫–æ–Ω–æ–≤.
"""

import sys
from pathlib import Path
import logging

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø—É—Ç—å
sys.path.append(str(Path(__file__).parent.parent))

from app.ai.core import KnowledgeBase

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –°–ø–∏—Å–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–µ–º
REQUIRED_LAWS = {
    "tk_rf.txt": "–¢—Ä—É–¥–æ–≤–æ–π –∫–æ–¥–µ–∫—Å –†–§ (–æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç)",
    "426_fz.txt": "–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –∑–∞–∫–æ–Ω ‚Ññ426-–§–ó '–û —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–µ —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞'",
    "2464_pp.txt": "–ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Ññ2464 '–û –ø–æ—Ä—è–¥–∫–µ –æ–±—É—á–µ–Ω–∏—è –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞'",
    "776n_prikaz.txt": "–ü—Ä–∏–∫–∞–∑ –ú–∏–Ω—Ç—Ä—É–¥–∞ ‚Ññ776–Ω '–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞'",
    "772n_prikaz.txt": "–ü—Ä–∏–∫–∞–∑ –ú–∏–Ω—Ç—Ä—É–¥–∞ ‚Ññ772–Ω '–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–∞–≤–∏–ª–∞–º –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞'"
}

def check_required_files(data_dir: Path):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤."""
    missing_files = []
    
    for filename, description in REQUIRED_LAWS.items():
        file_path = data_dir / filename
        if not file_path.exists():
            missing_files.append((filename, description))
            logger.warning(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: {filename} ({description})")
        else:
            size_kb = file_path.stat().st_size / 1024
            logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω: {filename} ({size_kb:.1f} –ö–ë) - {description}")
    
    return missing_files

def create_sample_files(data_dir: Path):
    """–°–æ–∑–¥–∞–µ—Ç –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)."""
    sample_content = {
        "426_fz.txt": "–§–ï–î–ï–†–ê–õ–¨–ù–´–ô –ó–ê–ö–û–ù ‚Ññ426-–§–ó\n–û —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–µ —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞\n\n–°—Ç–∞—Ç—å—è 1. –¶–µ–ª–∏ –∏ –ø—Ä–µ–¥–º–µ—Ç —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞\n–ù–∞—Å—Ç–æ—è—â–∏–π –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –∑–∞–∫–æ–Ω —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞...\n\n–°—Ç–∞—Ç—å—è 2. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è\n–î–ª—è —Ü–µ–ª–µ–π –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è:\n1) —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞ - –µ–¥–∏–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ–º—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π...",
        "2464_pp.txt": "–ü–û–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ü–†–ê–í–ò–¢–ï–õ–¨–°–¢–í–ê –†–§ ‚Ññ2464\n–û –ø–æ—Ä—è–¥–∫–µ –æ–±—É—á–µ–Ω–∏—è –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞\n\nI. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è\n1. –ù–∞—Å—Ç–æ—è—â–µ–µ –ü–æ–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –æ–±—É—á–µ–Ω–∏—è –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞...\n\n2. –û–±—É—á–µ–Ω–∏–µ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç:\n–∞) —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π...",
        "776n_prikaz.txt": "–ü–†–ò–ö–ê–ó –ú–∏–Ω—Ç—Ä—É–¥–∞ –†–§ ‚Ññ776–Ω\n–û–± —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ü—Ä–∏–º–µ—Ä–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è –æ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞\n\n1. –£—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–∏–ª–∞–≥–∞–µ–º–æ–µ –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞.\n\n2. –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è–º...",
        "772n_prikaz.txt": "–ü–†–ò–ö–ê–ó –ú–∏–Ω—Ç—Ä—É–¥–∞ –†–§ ‚Ññ772–Ω\n–û–± —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–æ—Ä—è–¥–∫—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é –ø—Ä–∞–≤–∏–ª –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞\n\n1. –£—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–∏–ª–∞–≥–∞–µ–º—ã–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—Ä—è–¥–∫—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é –ø—Ä–∞–≤–∏–ª –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞...\n\n2. –ü—Ä–∞–≤–∏–ª–∞ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ–∂–æ—Ç—Ä–∞—Å–ª–µ–≤—ã—Ö –∏ –æ—Ç—Ä–∞—Å–ª–µ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª..."
    }
    
    created_files = []
    for filename, content in sample_content.items():
        file_path = data_dir / filename
        if not file_path.exists():
            file_path.write_text(content, encoding='utf-8')
            created_files.append(filename)
            logger.info(f"üìù –°–æ–∑–¥–∞–Ω–∞ –∑–∞–≥–ª—É—à–∫–∞: {filename}")
    
    return created_files

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."""
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞")
    logger.info("=" * 60)
    
    # –ü—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º
    data_dir = Path(__file__).parent.parent / "data" / "texts"
    data_dir.mkdir(parents=True, exist_ok=True)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤
    logger.info("üîç –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...")
    missing_files = check_required_files(data_dir)
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
    if missing_files:
        logger.info(f"\n‚ö†Ô∏è  –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç {len(missing_files)} –∏–∑ {len(REQUIRED_LAWS)} –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.")
        logger.info("–°–æ–∑–¥–∞—é –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...")
        created = create_sample_files(data_dir)
        if created:
            logger.info(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ {len(created)} –∑–∞–≥–ª—É—à–µ–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.")
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
    text_files = list(data_dir.glob("*.txt"))
    
    if not text_files:
        logger.error("‚ùå –ù–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏!")
        return
    
    logger.info(f"\nüìö –ù–∞–π–¥–µ–Ω–æ {len(text_files)} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:")
    for i, file_path in enumerate(text_files, 1):
        size_kb = file_path.stat().st_size / 1024
        logger.info(f"  {i}. {file_path.name} ({size_kb:.1f} –ö–ë)")
    
    # –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
    logger.info("\nüß† –°–æ–∑–¥–∞—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π...")
    try:
        kb = KnowledgeBase()
        
        # –ï—Å–ª–∏ —ç—Ç–æ AdvancedKnowledgeBase, —Å–æ–∑–¥–∞–µ–º –≤–µ–∫—Ç–æ—Ä–Ω—É—é –ë–î
        if hasattr(kb, 'create_vectorstore_from_documents'):
            logger.info("üîÑ –ò—Å–ø–æ–ª—å–∑—É—é –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫...")
            success = kb.create_vectorstore_from_documents()
            if success:
                logger.info("‚úÖ –í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!")
            else:
                logger.warning("‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—É—é –ë–î. –ò—Å–ø–æ–ª—å–∑—É—é –ø—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫.")
                kb.load_documents(text_files)
        else:
            logger.info("üîÑ –ò—Å–ø–æ–ª—å–∑—É—é –ø—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫...")
            kb.load_documents(text_files)
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫
        logger.info("\nüîç –¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–∏—Å–∫ –ø–æ —Ä–∞–∑–Ω—ã–º —Ç–µ–º–∞–º...")
        
        test_queries = [
            ("–æ—Ç–ø—É—Å–∫ –µ–∂–µ–≥–æ–¥–Ω—ã–π –æ–ø–ª–∞—á–∏–≤–∞–µ–º—ã–π", "–¢–ö –†–§: –û—Ç–ø—É—Å–∫–∞"),
            ("—Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞", "426-–§–ó: –°–û–£–¢"),
            ("–æ–±—É—á–µ–Ω–∏–µ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞", "2464: –û–±—É—á–µ–Ω–∏–µ"),
            ("—Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ö—Ä–∞–Ω–æ–π —Ç—Ä—É–¥–∞", "776–Ω: –°–£–û–¢"),
            ("–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞", "772–Ω: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏")
        ]
        
        for query, expected_source in test_queries:
            logger.info(f"\n  –ü–æ–∏—Å–∫: '{query}'")
            results = kb.search(query, k=1)
            
            if results:
                doc, score = results[0]
                found_source = doc.metadata.get('source', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                logger.info(f"    ‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤: {found_source} (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {score:.3f})")
                logger.info(f"    üìÑ –§—Ä–∞–≥–º–µ–Ω—Ç: {doc.page_content[:100]}...")
            else:
                logger.info(f"    ‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω–æ (–æ–∂–∏–¥–∞–ª–æ—Å—å –≤ {expected_source})")
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        logger.info("\nüìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô:")
        logger.info(f"   ‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {len(text_files)}")
        logger.info(f"   ‚Ä¢ –§—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: {kb.get_document_count()}")
        logger.info(f"   ‚Ä¢ –ë–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {kb.get_db_path()}")
        
        logger.info("\nüéâ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
        logger.info("–¢–µ–ø–µ—Ä—å –±–æ—Ç –º–æ–∂–µ—Ç –∏—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –≤–æ –í–°–ï–• –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞.")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()
